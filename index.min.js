/*! stampery-node 2016-04-25 */
(function(){var a,b,c,d,e,f,g,h,i,j=function(a,b){return function(){return a.apply(b,arguments)}};f=require("iced-runtime"),h=i=function(){},e=require("crypto"),g=require("stream"),b=require("rocksolidsocket"),a=require("msgpackrpc"),d=require("amqplib/callback_api"),c=function(){function c(c,d){var e;this.clientSecret=c,this.beta=d,this._connectRabbit=j(this._connectRabbit,this),this.clientId=this._hash("md5",this.clientSecret).substring(0,15),e=new b("localhost:4000"),this.rpc=new a("stampery.3",e),this._auth(),this._connectRabbit()}return c.prototype.hashCache=[],c.prototype._connectRabbit=function(){var a,b,c,e,g,h;h=i,e=f.findDeferral(arguments),function(b){return function(c){g=new f.Deferrals(c,{parent:e,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),d.connect("amqp://consumer:9FBln3UxOgwgLZtYvResNXE7@young-squirrel.rmq.cloudamqp.com/ukgmnhoi",g.defer({assign_fn:function(b){return function(){return a=arguments[0],b.rabbit=arguments[1]}}(b),lineno:19})),g._fulfill()}}(this)(function(d){return function(){return a?console.log("[QUEUE] Error connecting "+a):(d.rabbit.on("error",d._connectRabbit),void function(b){g=new f.Deferrals(b,{parent:e,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),d.rabbit.createChannel(g.defer({assign_fn:function(b){return function(){return a=arguments[0],b.channel=arguments[1]}}(d),lineno:23})),g._fulfill()}(function(){return d.rabbit&&0!==d.hashCache.length?void!function(h){var i,j,k,l,m;l=d.hashCache,k=function(){var a;a=[];for(j in l)a.push(j);return a}(),i=0,(m=function(h){var j,l,n;return j=h,l=function(){return f.trampoline(function(){return++i,m(h)})},n=l,i<k.length?(b=k[i],void function(h){return d.channel?void!function(h){g=new f.Deferrals(h,{parent:e,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),d.channel.assertQueue(""+d.hashCache[b]+"-clnt",{durable:!0},g.defer({assign_fn:function(){return function(){return a=arguments[0],c=arguments[1]}}(),lineno:27})),g._fulfill()}(h):h()}(n)):j()})(h)}(h):h()}))}}(this))},c.prototype._hash=function(a,b){return e.createHash(a).update(b).digest("hex")},c.prototype.hash=function(a,b){return a instanceof g?this._hashFile(a,b):this._hash("sha256",a)},c.prototype._hashFile=function(a,b){var c;return c=e.createHash("sha256"),c.setEncoding("hex"),a.on("end",function(){return c.end(),b(c.read())}),a.pipe(c)},c.prototype._auth=function(){var a,b,c,d,e;e=i,c=f.findDeferral(arguments),function(e){return function(g){d=new f.Deferrals(g,{parent:c,filename:"./index.iced",funcname:"Stampery._auth"}),e.rpc.invoke("auth",[e.clientId,e.clientSecret],d.defer({assign_fn:function(){return function(){return a=arguments[0],b=arguments[1]}}(),lineno:48})),d._fulfill()}}(this)(function(c){return function(){return console.log(a,b),a?console.log("[RPC] Auth error: "+a):void 0}}(this))},c.prototype.stamp=function(a,b){var c,d,e,g,h,j;return j=i,g=f.findDeferral(arguments),this.hashCache.push(a),this.rabbit?void function(b){return function(d){h=new f.Deferrals(d,{parent:g,filename:"./index.iced",funcname:"Stampery.stamp"}),b.rpc.invoke("stamp",[a],h.defer({assign_fn:function(){return function(){return c=arguments[0],e=arguments[1]}}(),lineno:55})),h._fulfill()}}(this)(function(e){return function(){return c?(console.log("[RPC] Error: "+c),b(c,null)):(console.log(b),d?(console.log("[QUEUE] Bound to "+a+"-clnt"),void function(b){return e.channel?void!function(b){h=new f.Deferrals(b,{parent:g,filename:"./index.iced",funcname:"Stampery.stamp"}),e.channel.assertQueue(""+a+"-clnt",{durable:!0},h.defer({assign_fn:function(){return function(){return c=arguments[0],d=arguments[1]}}(),lineno:63})),h._fulfill()}(b):b()}(function(){return j(channel.consume(""+a+"-clnt",function(c){return delete this.hashCache[this.hashCache.indexOf(a)],console.log("[QUEUE] Received -> %s",c.content.toString()),channel.ack(c),b(null,c)}))})):j(b("Error binding to "+a+"-clnt",null)))}}(this)):setTimeout(this.stamp.bind(this,a,b),500)},c}(),module.exports=c}).call(this);