/*! stampery-node 2016-04-14 */
(function(){var a,b,c,d,e,f,g,h,i,j,k,l=function(a,b){return function(){return a.apply(b,arguments)}};f=require("iced-runtime"),j=k=function(){},e=require("crypto"),g=require("net"),a=require("msgpackrpc"),h=require("retry"),i=require("stream"),b=require("rocksolidsocket"),d=require("amqplib/callback_api"),c=function(){function c(c,d){var f;this.apiSecret=c,this.beta=d,this.stamp=l(this.stamp,this),f=e.createHash("md5"),f.update(this.apiSecret),f=f.digest("hex"),this.clientId=f.substring(0,15),this.sock=new b("localhost:4000"),this.rpc=new a("stampery.3",this.sock),this.authed=!1,this.connected=!1}return c.prototype.connectToQueue=function(a){var b,c,e,g;return g=k,c=f.findDeferral(arguments),this.connected?g(a(null,this.conn)):void!function(a){return function(g){e=new f.Deferrals(g,{parent:c,filename:"./index.iced",funcname:"Stampery.connectToQueue"}),d.connect("amqp://ukgmnhoi:iP8PxJN_rPTT2lls6CEeKsC93aEnQKgx@young-squirrel.rmq.cloudamqp.com/ukgmnhoi",e.defer({assign_fn:function(a){return function(){return b=arguments[0],a.conn=arguments[1]}}(a),lineno:25})),e._fulfill()}}(this)(function(c){return function(){return b?(console.log("[QUEUE] Error connecting "+b),a(b,null)):(c.connected=!0,a(null,c.conn)),g(c.conn.on("error",function(b){return console.log("[QUEUE] Connection error: "+b),a(b,null)}))}}(this))},c.prototype.hash=function(a){var b;return b=e.createHash("sha256"),b.update(a),b.digest("hex")},c.prototype.hashFile=function(a,b){var c;return c=e.createHash("sha256"),c.setEncoding("hex"),a.on("end",function(){return c.end(),b(c.read())}),a.pipe(c)},c.prototype.stamp=function(a,b){var c,d,e,g,h,j,l;l=k,h=f.findDeferral(arguments),c=null,function(b){return function(d){return a instanceof i?void!function(c){j=new f.Deferrals(c,{parent:h,filename:"./index.iced",funcname:"Stampery.stamp"}),b.hashFile(a,j.defer({assign_fn:function(){return function(){return e=arguments[0]}}(),lineno:56})),j._fulfill()}(function(){return d(c=e)}):d(c=b.hash(a))}}(this)(function(a){return function(){!function(c){return a.authed?c():(console.log("[RPC] No auth"),void function(b){j=new f.Deferrals(b,{parent:h,filename:"./index.iced",funcname:"Stampery.stamp"}),a.rpc.invoke("auth",[a.clientId,a.apiSecret],j.defer({assign_fn:function(){return function(){return d=arguments[0],g=arguments[1]}}(),lineno:63})),j._fulfill()}(function(){return d?b(d,null):(console.log("[RPC] Authed: "+d+", "+g),c())}))}(function(){!function(b){j=new f.Deferrals(b,{parent:h,filename:"./index.iced",funcname:"Stampery.stamp"}),a.rpc.invoke("stamp",[c],j.defer({assign_fn:function(){return function(){return d=arguments[0],g=arguments[1]}}(),lineno:69})),j._fulfill()}(function(){return d&&console.log("[RPC] Error: "+d),a.connectToQueue(function(b,d){var e,g,h,i,j;return j=k,h=f.findDeferral(arguments),b?j(console.log("[QUEUE] Error connecting to RabbitMQ")):void!function(c){i=new f.Deferrals(c,{parent:h,filename:"./index.iced"}),a.conn.createChannel(i.defer({assign_fn:function(){return function(){return b=arguments[0],e=arguments[1]}}(),lineno:76})),i._fulfill()}(function(){!function(a){i=new f.Deferrals(a,{parent:h,filename:"./index.iced"}),e.assertQueue(c,{durable:!0},i.defer({assign_fn:function(){return function(){return b=arguments[0],g=arguments[1]}}(),lineno:77})),i._fulfill()}(function(){return j(e.consume(c,function(a){return console.log("[QUEUE] Received -> %s",a.content.toString()),e.ack(a)}))})})})})})}}(this))},c}(),module.exports=c}).call(this);