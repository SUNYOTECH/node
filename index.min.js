/*! stampery-node 2016-10-27 */
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r=function(a,b){return function(){return a.apply(b,arguments)}};j=require("iced-runtime"),p=q=function(){},h=require("crypto"),n=require("stream"),d=require("js-sha3"),c=require("rocksolidsocket"),b=require("msgpackrpc"),f=require("amqplib/callback_api"),k=require("msgpack"),i=require("domain"),o=require("util"),m=require("request"),a=require("events").EventEmitter,l=require("./package.json"),g=i.create(),g.on("error",function(a){return function(a){return console.log("[QUEUE] Error with queue: "+a)}}(this)),e=function(){function a(a,d){var e,f,g,i,k;k=q,g=j.findDeferral(arguments),this.clientSecret=a,this.beta=d,this.checkRootInChain=r(this.checkRootInChain,this),this.checkSiblings=r(this.checkSiblings,this),this.prove=r(this.prove,this),this._merkleMixer=r(this._merkleMixer,this),this._convertSiblingArray=r(this._convertSiblingArray,this),this._processProof=r(this._processProof,this),this._handleQueueConsumingForHash=r(this._handleQueueConsumingForHash,this),this._auth=r(this._auth,this),this._connectRabbit=r(this._connectRabbit,this),this.clientId=h.createHash("md5").update(this.clientSecret).digest("hex").substring(0,15),e=this.beta?"api-beta.stampery.com:4000":"api.stampery.com:4000",f=new c(e),this.rpc=new b("stampery.3",f),function(a){return function(b){i=new j.Deferrals(b,{parent:g,filename:"./index.iced",funcname:"Stampery"}),a._auth(i.defer({assign_fn:function(a){return function(){return a.authed=arguments[0]}}(a),lineno:37})),i._fulfill()}}(this)(function(a){return function(){if(a.authed)return a._connectRabbit()}}(this))}return a.prototype.ethSiblings={},a.prototype.authed=!1,a.prototype._connectRabbit=function(){var a,b,c,d;d=q,b=j.findDeferral(arguments),function(d){return function(e){d.beta?!function(e){c=new j.Deferrals(e,{parent:b,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),f.connect("amqp://consumer:9FBln3UxOgwgLZtYvResNXE7@young-squirrel.rmq.cloudamqp.com/beta",c.defer({assign_fn:function(b){return function(){return a=arguments[0],b.rabbit=arguments[1]}}(d),lineno:43})),c._fulfill()}(e):!function(e){c=new j.Deferrals(e,{parent:b,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),f.connect("amqp://consumer:9FBln3UxOgwgLZtYvResNXE7@young-squirrel.rmq.cloudamqp.com/ukgmnhoi",c.defer({assign_fn:function(b){return function(){return a=arguments[0],b.rabbit=arguments[1]}}(d),lineno:45})),c._fulfill()}(e)}}(this)(function(b){return function(){return a?console.log("[QUEUE] Error connecting "+a):b.rabbit?(console.log("[QUEUE] Connected to Rabbit!"),b.emit("ready"),g.add(b.rabbit),b._handleQueueConsumingForHash(b.clientId),b.rabbit.on("error",function(a){return b.emit("error",a),b._connectRabbit})):void 0}}(this))},a.prototype._sha3Hash=function(a,b){return b(d.sha3_512(a))},a.prototype._hashFile=function(a,b){var c;return c=new d.sha3_512.create,a.on("end",function(){return b(c.hex())}),a.on("data",function(a){return c.update(a)})},a.prototype._auth=function(a){var b,c,d,e,f;f=q,d=j.findDeferral(arguments),function(a){return function(f){e=new j.Deferrals(f,{parent:d,filename:"./index.iced",funcname:"Stampery._auth"}),a.rpc.invoke("auth",[a.clientId,a.clientSecret,"nodejs-"+l.version],e.defer({assign_fn:function(){return function(){return b=arguments[0],c=arguments[1]}}(),lineno:70})),e._fulfill()}}(this)(function(c){return function(){return b&&(c.auth=!1,c.emit("error","Couldn't authenticate"),process.exit()),a(!0)}}(this))},a.prototype._handleQueueConsumingForHash=function(a){var b,c,d,e;return e=q,c=j.findDeferral(arguments),this.rabbit?void!function(a){return function(e){d=new j.Deferrals(e,{parent:c,filename:"./index.iced",funcname:"Stampery._handleQueueConsumingForHash"}),a.rabbit.createChannel(d.defer({assign_fn:function(a){return function(){return b=arguments[0],a.channel=arguments[1]}}(a),lineno:79})),d._fulfill()}}(this)(function(c){return function(){return console.log("[QUEUE] Bound to "+a+"-clnt",b),e(c.channel.consume(""+a+"-clnt",function(a){var b,d,e;return e=k.unpack(a.content),b=a.fields.routingKey,1===e[3][0]||e[3][0]===-1?console.log("[QUEUE] Received BTC proof for "+b):2!==e[3][0]&&e[3][0]!==-2||console.log("[QUEUE] Received ETH proof for "+b),c.channel.ack(a),d=c._processProof(e),c.emit("proof",b,d)}))}}(this)):e(this.emit("error","Error binding to "+hash+"-clnt"))},a.prototype._processProof=function(a){return{version:a[0],siblings:this._convertSiblingArray(a[1]),root:a[2].toString("utf8"),anchor:{chain:a[3][0],tx:a[3][1].toString("utf8")}}},a.prototype._convertSiblingArray=function(a){return""===a?[]:a.map(function(a,b){return a.toString()})},a.prototype._merkleMixer=function(a,b,c){var d,e;return a>b&&(e=[b,a],a=e[0],b=e[1]),d=a+b,this._sha3Hash(d,c)},a.prototype.prove=function(a,b,c){var d,e,f,g;g=q,e=j.findDeferral(arguments),function(c){return function(g){f=new j.Deferrals(g,{parent:e,filename:"./index.iced",funcname:"Stampery.prove"}),c.checkSiblings(a,b.siblings,b.root,f.defer({assign_fn:function(){return function(){return d=arguments[0]}}(),lineno:124})),f._fulfill()}}(this)(function(a){return function(){return c(d)}}(this))},a.prototype.checkDataIntegrity=function(a,b,c){var d,e,f,g,h;h=q,f=j.findDeferral(arguments),function(b){return function(c){g=new j.Deferrals(c,{parent:f,filename:"./index.iced",funcname:"Stampery.checkDataIntegrity"}),b.hash(a,g.defer({assign_fn:function(){return function(){return d=arguments[0]}}(),lineno:128})),g._fulfill()}}(this)(function(a){return function(){return a.prove(d,b,g.defer({assign_fn:function(){return function(){return e=arguments[0]}}(),lineno:129})),c(e)}}(this))},a.prototype.checkSiblings=function(a,b,c,d){var e,f,g,h,i;return i=q,g=j.findDeferral(arguments),b.length>0?(e=b[0],f=b.slice(1),function(b){return function(c){h=new j.Deferrals(c,{parent:g,filename:"./index.iced",funcname:"Stampery.checkSiblings"}),b._merkleMixer(a,e,h.defer({assign_fn:function(){return function(){return a=arguments[0]}}(),lineno:136})),h._fulfill()}}(this)(function(b){return function(){console.log("Resulting in",a),function(e){h=new j.Deferrals(e,{parent:g,filename:"./index.iced",funcname:"Stampery.checkSiblings"}),b.checkSiblings(a,f,c,function(a){return d(a)}),h._fulfill()}(i)}}(this)),void 0):(console.log("A_Root",a),console.log("B_Root",c),i(d(a===c)))},a.prototype.checkRootInChain=function(a,b,c,d){var e,f,g,h,i;i=q,g=j.findDeferral(arguments),f=this._getBTCtx,2===b&&(f=this._getETHtx),function(a){return function(a){h=new j.Deferrals(a,{parent:g,filename:"./index.iced",funcname:"Stampery.checkRootInChain"}),f(c,h.defer({assign_fn:function(){return function(){return e=arguments[0]}}(),lineno:149})),h._fulfill()}}(this)(function(b){return function(){return d(e.indexOf(a.toLowerCase())>=0)}}(this))},a.prototype.stamp=function(a){return console.log("\nStamping \n"+a),a=a.toUpperCase(),this.rpc.invoke("stamp",[a],function(a){return function(b,c){if(console.log("[API] Received response: ",c),b)return console.log("[RPC] Error: "+b),a.emit("error",b)}}(this))},a.prototype.hash=function(a,b){return a instanceof n?this._hashFile(a,b):this._sha3Hash(a,function(a){return b(a.toUpperCase())})},a}(),o.inherits(e,a),module.exports=e}).call(this);