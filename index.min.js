/*! stampery-node 2016-04-29 */
(function(){var a,b,c,d,e,f,g,h,i,j,k,l=function(a,b){return function(){return a.apply(b,arguments)}};g=require("iced-runtime"),j=k=function(){},f=require("crypto"),i=require("stream"),c=require("sha3"),b=require("rocksolidsocket"),a=require("msgpackrpc"),e=require("amqplib/callback_api"),h=require("msgpack"),d=function(){function d(c,d){var e,f;this.clientSecret=c,this.beta=d,this._connectRabbit=l(this._connectRabbit,this),this.clientId=this._hash("md5",this.clientSecret).substring(0,15),e=this.beta?"api-beta-0.us-east.aws.stampery.com:4000":"api-0.us-east.aws.stampery.com:4000",f=new b(e),this.rpc=new a("stampery.3",f),this._auth(),this._connectRabbit()}return d.prototype._connectRabbit=function(){var a,b,c,d;d=k,b=g.findDeferral(arguments),function(d){return function(f){c=new g.Deferrals(f,{parent:b,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),e.connect("amqp://consumer:9FBln3UxOgwgLZtYvResNXE7@young-squirrel.rmq.cloudamqp.com/ukgmnhoi",c.defer({assign_fn:function(b){return function(){return a=arguments[0],b.rabbit=arguments[1]}}(d),lineno:24})),c._fulfill()}}(this)(function(b){return function(){return a?console.log("[QUEUE] Error connecting "+a):b.rabbit.on("error",b._connectRabbit)}}(this))},d.prototype._hash=function(a,b){return f.createHash(a).update(b).digest("hex")},d.prototype.hash=function(a,b){var d;return a instanceof i?this._hashFile(a,b):(d=new c.SHA3Hash,d.update(a),b(d.digest("hex")))},d.prototype._sha3Hash=function(a,b){var d;return d=new c.SHA3Hash,d.update(a),b(d.digest("hex"))},d.prototype._hashFile=function(a,b){var d;return d=new c.SHA3Hash,a.on("end",function(){return b(d.digest("hex"))}),a.on("data",function(a){return d.update(a)})},d.prototype._auth=function(){var a,b,c,d,e;e=k,c=g.findDeferral(arguments),function(e){return function(f){d=new g.Deferrals(f,{parent:c,filename:"./index.iced",funcname:"Stampery._auth"}),e.rpc.invoke("auth",[e.clientId,e.clientSecret],d.defer({assign_fn:function(){return function(){return a=arguments[0],b=arguments[1]}}(),lineno:53})),d._fulfill()}}(this)(function(c){return function(){return console.log("[RPC] Auth: ",a,b),a?console.log("[RPC] Auth error: "+a):void 0}}(this))},d.prototype.retrieveProofForHash=function(a,b){var c,d,e,f,h;h=k,e=g.findDeferral(arguments),function(a){return function(b){f=new g.Deferrals(b,{parent:e,filename:"./index.iced",funcname:"Stampery.retrieveProofForHash"}),a.rabbit.createChannel(f.defer({assign_fn:function(a){return function(){return c=arguments[0],a.channel=arguments[1]}}(a),lineno:58})),f._fulfill()}}(this)(function(h){return function(){console.log("[QUEUE] Bound to "+a+"-clnt",c),function(b){return h.channel?void!function(b){f=new g.Deferrals(b,{parent:e,filename:"./index.iced",funcname:"Stampery.retrieveProofForHash"}),h.channel.assertQueue(""+a+"-clnt",{durable:!0},f.defer({assign_fn:function(){return function(){return c=arguments[0],d=arguments[1]}}(),lineno:60})),f._fulfill()}(b):b()}(function(){return h.channel.consume(""+a+"-clnt",function(c){return delete this.hashCache[this.hashCache.indexOf(a)],console.log("[QUEUE] Received -> %s",c.content.toString()),this.channel.ack(c),b(null,c)})})}}(this))},d.prototype.calculateProof=function(a,b,c){var d,e,f;e=a;for(d in b)f=b[d],console.log("[SIBLINGS] Calculating sibling "+d,e,f),this._sumSiblings(e,f,function(a){return console.log("[SIBLINGS] Calculated "+a),e=a});return c(e)},d.prototype._sumSiblings=function(a,b,c){var d,e,f,h;h=k,e=g.findDeferral(arguments),parseInt(a,16)>parseInt(b,16)?(console.log("[SIBLINGS] Leave1 is bigger than Leave2"),function(c){return function(h){f=new g.Deferrals(h,{parent:e,filename:"./index.iced",funcname:"Stampery._sumSiblings"}),c._sha3Hash(""+a+b,f.defer({assign_fn:function(){return function(){return d=arguments[0]}}(),lineno:81})),f._fulfill()}}(this)(function(a){return function(){return h(c(d))}}(this))):(console.log("[SIBLINGS] Leave2 is bigger than Leave1"),function(c){return function(h){f=new g.Deferrals(h,{parent:e,filename:"./index.iced",funcname:"Stampery._sumSiblings"}),c._sha3Hash(""+b+a,f.defer({assign_fn:function(){return function(){return d=arguments[0]}}(),lineno:85})),f._fulfill()}}(this)(function(a){return function(){return h(c(d))}}(this)))},d.prototype.stamp=function(a,b){var c,d,e,f,i;return i=k,e=g.findDeferral(arguments),a=a.toUpperCase(),this.rabbit?void function(b){return function(h){f=new g.Deferrals(h,{parent:e,filename:"./index.iced",funcname:"Stampery.stamp"}),b.rpc.invoke("stamp",[a],f.defer({assign_fn:function(){return function(){return c=arguments[0],d=arguments[1]}}(),lineno:91})),f._fulfill()}}(this)(function(d){return function(){return c?(console.log("[RPC] Error: "+c),b(c,null)):d.rabbit?void!function(a){f=new g.Deferrals(a,{parent:e,filename:"./index.iced",funcname:"Stampery.stamp"}),d.rabbit.createChannel(f.defer({assign_fn:function(a){return function(){return c=arguments[0],a.channel=arguments[1]}}(d),lineno:97})),f._fulfill()}(function(){return console.log("[QUEUE] Bound to "+a+"-clnt",c),i(d.channel.consume(""+a+"-clnt",function(c){var e;return d.channel.ack(c),e=h.unpack(c.content),console.log(1===e[3][0]||-1===e[3][0],2===e[3][0]||-2===e[3][0]),1===e[3][0]||-1===e[3][0]?(console.log("[QUEUE-BTC] Detected data: ",c.content.toString()),console.log("[QUEUE-BTC] Received -> %s",e[1]),b(null,e)):2===e[3][0]||-2===e[3][0]?(console.log("[QUEUE-ETH] Received ETH -> %s",e[1]),console.log("[QUEUE-BTC] Bound to "+e[1]+"-clnt"),""+e[1]+"-clnt"!=""+a+"-clnt"&&d.channel.consume(""+e[1]+"-clnt",function(a){var c;return console.log("[QUEUE-BTC] Detected data: ",a.content.toString()),c=h.unpack(a.content),console.log("[QUEUE-BTC] Received -> %s",c),b(null,c)}),b(null,e)):void 0}))}):i(b("Error binding to "+a+"-clnt",null))}}(this)):setTimeout(this.stamp.bind(this,a,b),500)},d}(),module.exports=d}).call(this);