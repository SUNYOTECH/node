/*! stampery-node 2016-04-16 */
(function(){var a,b,c,d,e,f,g,h,i,j=function(a,b){return function(){return a.apply(b,arguments)}};f=require("iced-runtime"),h=i=function(){},e=require("crypto"),g=require("stream"),b=require("rocksolidsocket"),a=require("msgpackrpc"),d=require("amqplib/callback_api"),c=function(){function c(c,d){var e;this.clientSecret=c,this.beta=d,this._connectRabbit=j(this._connectRabbit,this),this.clientId=this._hash("md5",this.clientSecret).substring(0,15),e=new b("localhost:4000"),this.rpc=new a("stampery.3",e),this._auth(),this._connectRabbit()}return c.prototype._connectRabbit=function(){var a,b,c,e;e=i,b=f.findDeferral(arguments),function(e){return function(g){c=new f.Deferrals(g,{parent:b,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),d.connect("amqp://consumer:9FBln3UxOgwgLZtYvResNXE7@young-squirrel.rmq.cloudamqp.com/ukgmnhoi",c.defer({assign_fn:function(b){return function(){return a=arguments[0],b.rabbit=arguments[1]}}(e),lineno:16})),c._fulfill()}}(this)(function(b){return function(){return a?console.log(console.log("[QUEUE] Error connecting "+a)):b.rabbit.on("error",b._connectRabbit)}}(this))},c.prototype._hash=function(a,b){return e.createHash(a).update(b).digest("hex")},c.prototype.hash=function(a,b){return a instanceof g?this._hashFile(a,b):this._hash("sha256",a)},c.prototype._hashFile=function(a,b){var c;return c=e.createHash("sha256"),c.setEncoding("hex"),a.on("end",function(){return c.end(),b(c.read())}),a.pipe(c)},c.prototype._auth=function(){var a,b,c,d,e;e=i,c=f.findDeferral(arguments),function(e){return function(g){d=new f.Deferrals(g,{parent:c,filename:"./index.iced",funcname:"Stampery._auth"}),e.rpc.invoke("auth",[e.clientId,e.clientSecret],d.defer({assign_fn:function(){return function(){return a=arguments[0],b=arguments[1]}}(),lineno:39})),d._fulfill()}}(this)(function(b){return function(){return a?console.log("[RPC] Auth error: "+a):void 0}}(this))},c.prototype.stamp=function(a,b){var c,d,e,g,h,j;return j=i,g=f.findDeferral(arguments),this.rabbit?void function(b){return function(c){h=new f.Deferrals(c,{parent:g,filename:"./index.iced",funcname:"Stampery.stamp"}),b.rpc.invoke("stamp",[a],h.defer({assign_fn:function(){return function(){return d=arguments[0],e=arguments[1]}}(),lineno:45})),h._fulfill()}}(this)(function(e){return function(){return d?console.log("[RPC] Error: "+d):void function(a){h=new f.Deferrals(a,{parent:g,filename:"./index.iced",funcname:"Stampery.stamp"}),e.rabbit.createChannel(h.defer({assign_fn:function(){return function(){return d=arguments[0],c=arguments[1]}}(),lineno:48})),h._fulfill()}(function(){return console.log("[QUEUE] Bound to "+a+"-clnt"),c.consume(""+a+"-clnt",function(a){return console.log("[QUEUE] Received -> %s",a.content.toString()),c.ack(a),b(a)})})}}(this)):setTimeout(this.stamp.bind(this,a,b),500)},c}(),module.exports=c}).call(this);