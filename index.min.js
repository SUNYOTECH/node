/*! stampery-node 2016-06-22 */
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=function(a,b){return function(){return a.apply(b,arguments)}};j=require("iced-runtime"),o=p=function(){},h=require("crypto"),m=require("stream"),d=require("sha3"),c=require("rocksolidsocket"),b=require("msgpackrpc"),f=require("amqplib/callback_api"),k=require("msgpack"),i=require("domain"),n=require("util"),l=require("request"),a=require("events").EventEmitter,g=i.create(),g.on("error",function(a){return function(a){return console.log("[QUEUE] Error with queue: "+a)}}(this)),e=function(){function a(a,d){var e,f;this.clientSecret=a,this.beta=d,this._merkleMixer=q(this._merkleMixer,this),this.receiveMissedProofs=q(this.receiveMissedProofs,this),this._handleQueueConsumingForHash=q(this._handleQueueConsumingForHash,this),this._auth=q(this._auth,this),this._connectRabbit=q(this._connectRabbit,this),this._recursiveConvert=q(this._recursiveConvert,this),this._convertSiblingArray=q(this._convertSiblingArray,this),this.clientId=this._hash("md5",this.clientSecret).substring(0,15),e=this.beta?"api-beta.stampery.com:4000":"api.stampery.com:4000",f=new c(e),this.rpc=new b("stampery.3",f),this._connectRabbit()}return a.prototype.ethSiblings={},a.prototype.authed=!1,a.prototype._convertSiblingArray=function(a){return""===a?[]:a.map(function(a,b){return a.toString()})},a.prototype._recursiveConvert=function(a){return a.map(function(a){return function(b){return b instanceof Buffer?b=b.toString("utf8"):b instanceof Array&&(b=a._recursiveConvert(b)),b}}(this))},a.prototype._connectRabbit=function(){var a,b,c,d;d=p,b=j.findDeferral(arguments),function(d){return function(e){d.beta?!function(e){c=new j.Deferrals(e,{parent:b,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),f.connect("amqp://consumer:9FBln3UxOgwgLZtYvResNXE7@young-squirrel.rmq.cloudamqp.com/beta",c.defer({assign_fn:function(b){return function(){return a=arguments[0],b.rabbit=arguments[1]}}(d),lineno:50})),c._fulfill()}(e):!function(e){c=new j.Deferrals(e,{parent:b,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),f.connect("amqp://consumer:9FBln3UxOgwgLZtYvResNXE7@young-squirrel.rmq.cloudamqp.com/ukgmnhoi",c.defer({assign_fn:function(b){return function(){return a=arguments[0],b.rabbit=arguments[1]}}(d),lineno:52})),c._fulfill()}(e)}}(this)(function(b){return function(){return a?console.log("[QUEUE] Error connecting "+a):(console.log("[QUEUE] Connected to Rabbit!"),b.emit("ready"),g.add(b.rabbit),b.rabbit.on("error",function(a){return b.emit("error",a),b._connectRabbit}))}}(this))},a.prototype._hash=function(a,b){return h.createHash(a).update(b).digest("hex")},a.prototype.hash=function(a,b){var c;return a instanceof m?this._hashFile(a,b):(c=new d.SHA3Hash,c.update(a),b(c.digest("hex").toUpperCase()))},a.prototype._sha3Hash=function(a,b){var c;return c=new d.SHA3Hash,c.update(a),b(c.digest("hex"))},a.prototype._hashFile=function(a,b){var c;return c=new d.SHA3Hash,a.on("end",function(){return b(c.digest("hex"))}),a.on("data",function(a){return c.update(a)})},a.prototype._auth=function(a){var b,c,d,e,f;f=p,d=j.findDeferral(arguments),function(a){return function(f){e=new j.Deferrals(f,{parent:d,filename:"./index.iced",funcname:"Stampery._auth"}),a.rpc.invoke("auth",[a.clientId,a.clientSecret],e.defer({assign_fn:function(){return function(){return b=arguments[0],c=arguments[1]}}(),lineno:86})),e._fulfill()}}(this)(function(d){return function(){return console.log("[RPC] Auth: ",b,c),b?d.emit("error",b):a(!0)}}(this))},a.prototype.calculateProof=function(a,b,c){var d,e,f;e=a;for(d in b)f=b[d],console.log("[SIBLINGS] Calculating sibling "+d,e,f),this._sumSiblings(e,f,function(a){return console.log("[SIBLINGS] Calculated "+a),e=a});return c(e)},a.prototype._sumSiblings=function(a,b,c){var d,e,f,g;g=p,e=j.findDeferral(arguments),parseInt(a,16)>parseInt(b,16)?(console.log("[SIBLINGS] Leaf1 is bigger than Leaf2"),function(c){return function(g){f=new j.Deferrals(g,{parent:e,filename:"./index.iced",funcname:"Stampery._sumSiblings"}),c._sha3Hash(""+a+b,f.defer({assign_fn:function(){return function(){return d=arguments[0]}}(),lineno:105})),f._fulfill()}}(this)(function(a){return function(){return g(c(d))}}(this))):(console.log("[SIBLINGS] Leaf2 is bigger than Leaf1"),function(c){return function(g){f=new j.Deferrals(g,{parent:e,filename:"./index.iced",funcname:"Stampery._sumSiblings"}),c._sha3Hash(""+b+a,f.defer({assign_fn:function(){return function(){return d=arguments[0]}}(),lineno:109})),f._fulfill()}}(this)(function(a){return function(){return g(c(d))}}(this)))},a.prototype._handleQueueConsumingForHash=function(a){var b,c,d,e;return e=p,c=j.findDeferral(arguments),this.rabbit?void!function(a){return function(e){d=new j.Deferrals(e,{parent:c,filename:"./index.iced",funcname:"Stampery._handleQueueConsumingForHash"}),a.rabbit.createChannel(d.defer({assign_fn:function(a){return function(){return b=arguments[0],a.channel=arguments[1]}}(a),lineno:114})),d._fulfill()}}(this)(function(c){return function(){return console.log("[QUEUE] Bound to "+a+"-clnt",b),e(c.channel.consume(""+a+"-clnt",function(a){var b,d,e;return console.log("[QUEUE] Received data!"),e=k.unpack(a.content),b=a.fields.routingKey,1===e[3][0]||e[3][0]===-1?(console.log("[QUEUE] Received BTC proof for "+b),e[1]=(c.ethSiblings[b]||[]).concat(e[1]||[])):2!==e[3][0]&&e[3][0]!==-2||(console.log("[QUEUE] Received ETH proof for "+b),c.ethSiblings[b]=c._convertSiblingArray(e[1])),c.channel.ack(a),d=c._recursiveConvert(e),c.emit("proof",b,d)}))}}(this)):e(this.emit("error","Error binding to "+hash+"-clnt"))},a.prototype.stamp=function(a){var b,c,d,e,f;f=p,d=j.findDeferral(arguments),console.log("Stamping "+a),function(a){return function(b){return a.authed?b():void!function(b){e=new j.Deferrals(b,{parent:d,filename:"./index.iced",funcname:"Stampery.stamp"}),a._auth(e.defer({assign_fn:function(a){return function(){return a.authed=arguments[0]}}(a),lineno:141})),e._fulfill()}(b)}}(this)(function(f){return function(){return a=a.toUpperCase(),console.log("Let's stamp "+a),f.rabbit?void function(g){e=new j.Deferrals(g,{parent:d,filename:"./index.iced",funcname:"Stampery.stamp"}),f.rpc.invoke("stamp",[a],e.defer({assign_fn:function(){return function(){return b=arguments[0],c=arguments[1]}}(),lineno:145})),e._fulfill()}(function(){return console.log("RES",b,c),f.authed?(console.log("[API] Received response: ",c),b?(console.log("[RPC] Error: "+b),f.emit("error",b)):void 0):f.emit("error","Not authenticated")}):setTimeout(f.stamp.bind(f,a),500)}}(this))},a.prototype.receiveMissedProofs=function(){return this._handleQueueConsumingForHash(this.clientId)},a.prototype._merkleMixer=function(a,b,c){var d,e;return b>a&&(e=[b,a],a=e[0],b=e[1]),d=a+b,_sha3Hash(d,c)},a.prototype.prove=function(a,b){var c,d;return d=this.checkSiblings(a,b[1],b[2]),c=this.checkRootInChain(b[2],b[3][0],b[3][1]),d&&c},a.prototype.checkDataIntegrity=function(a,b){var c,d,e,f;f=p,d=j.findDeferral(arguments),function(b){return function(f){e=new j.Deferrals(f,{parent:d,filename:"./index.iced",funcname:"Stampery.checkDataIntegrity"}),b.hash(a,e.defer({assign_fn:function(){return function(){return c=arguments[0]}}(),lineno:168})),e._fulfill()}}(this)(function(a){return function(){return a.prove(c,b)}}(this))},a.prototype.checkSiblings=function(a,b,c){var d,e,f,g,h;return h=p,f=j.findDeferral(arguments),b.length>0?(d=b[0],e=b.slice(1),function(b){return function(c){g=new j.Deferrals(c,{parent:f,filename:"./index.iced",funcname:"Stampery.checkSiblings"}),b._merkleMixer(a,d,g.defer({assign_fn:function(){return function(){return a=arguments[0]}}(),lineno:175})),g._fulfill()}}(this)(function(b){return function(){return h(b.checkSiblings(a,e,c))}}(this)),void 0):h(a===c)},a.prototype.checkRootInChain=function(a,b,c){var d,e;return e=this._getBTCtx(c),2===b&&(d=this._getETHtx(c)),e.indexOf(a.toLowerCase())},a.prototype._getBTCtx=function(a){return l("https://api.blockcypher.com/v1/btc/main/txs/"+a,function(a,b,c){if(a||!c||!JSON.parse(c).data_hex)throw new Error("BTC explorer error");return JSON.parse(c).outputs.find(function(a){return a.data_hex&&a.data_hex})})},a.prototype._getETHtx=function(a){return l("https://api.etherscan.io/api?module=proxy&action=eth_getTransactionByHash&txhash="+a,function(a,b,c){if(a||!c||!JSON.parse(c).result)throw new Error("ETH explorer error");return console.log(c),JSON.parse(c).result.input})},a}(),n.inherits(e,a),module.exports=e}).call(this);