/*! stampery-node 2016-05-10 */
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=function(a,b){return function(){return a.apply(b,arguments)}};j=require("iced-runtime"),n=o=function(){},h=require("crypto"),l=require("stream"),d=require("sha3"),c=require("rocksolidsocket"),b=require("msgpackrpc"),f=require("amqplib/callback_api"),k=require("msgpack"),i=require("domain"),m=require("util"),a=require("events").EventEmitter,g=i.create(),g.on("error",function(a){return function(a){return console.log("[QUEUE] Error with queue: "+a)}}(this)),e=function(){function a(a,d){var e,f;this.clientSecret=a,this.beta=d,this._connectRabbit=p(this._connectRabbit,this),this.clientId=this._hash("md5",this.clientSecret).substring(0,15),e=this.beta?"api-beta-0.us-east.aws.stampery.com:4000":"api-0.us-east.aws.stampery.com:4000",f=new c(e),this.rpc=new b("stampery.3",f),this._connectRabbit()}return a.prototype.ethSiblings={},a.prototype.authed=!1,a.prototype.convertSiblingArray=function(a){return""===a?[]:a.map(function(a,b){return new Buffer(a).toString()})},a.prototype._connectRabbit=function(){var a,b,c,d;d=o,b=j.findDeferral(arguments),function(d){return function(e){d.beta?!function(e){c=new j.Deferrals(e,{parent:b,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),f.connect("amqp://consumer:9FBln3UxOgwgLZtYvResNXE7@young-squirrel.rmq.cloudamqp.com/beta",c.defer({assign_fn:function(b){return function(){return a=arguments[0],b.rabbit=arguments[1]}}(d),lineno:41})),c._fulfill()}(e):!function(e){c=new j.Deferrals(e,{parent:b,filename:"./index.iced",funcname:"Stampery._connectRabbit"}),f.connect("amqp://consumer:9FBln3UxOgwgLZtYvResNXE7@young-squirrel.rmq.cloudamqp.com/ukgmnhoi",c.defer({assign_fn:function(b){return function(){return a=arguments[0],b.rabbit=arguments[1]}}(d),lineno:43})),c._fulfill()}(e)}}(this)(function(b){return function(){return a?console.log("[QUEUE] Error connecting "+a):(console.log("[QUEUE] Connected to Rabbit!"),b.emit("ready"),g.add(b.rabbit),b.rabbit.on("error",function(a){return b.emit("error",a),b._connectRabbit}))}}(this))},a.prototype._hash=function(a,b){return h.createHash(a).update(b).digest("hex")},a.prototype.hash=function(a,b){var c;return a instanceof l?this._hashFile(a,b):(c=new d.SHA3Hash,c.update(a),b(c.digest("hex").toUpperCase()))},a.prototype._sha3Hash=function(a,b){var c;return c=new d.SHA3Hash,c.update(a),b(c.digest("hex"))},a.prototype._hashFile=function(a,b){var c;return c=new d.SHA3Hash,a.on("end",function(){return b(c.digest("hex"))}),a.on("data",function(a){return c.update(a)})},a.prototype._auth=function(){var a,b,c,d,e;e=o,c=j.findDeferral(arguments),function(e){return function(f){d=new j.Deferrals(f,{parent:c,filename:"./index.iced",funcname:"Stampery._auth"}),e.rpc.invoke("auth",[e.clientId,e.clientSecret],d.defer({assign_fn:function(){return function(){return a=arguments[0],b=arguments[1]}}(),lineno:77})),d._fulfill()}}(this)(function(c){return function(){return console.log("[RPC] Auth: ",a,b),a?c.emit("error",a):c.authed=!0}}(this))},a.prototype.calculateProof=function(a,b,c){var d,e,f;e=a;for(d in b)f=b[d],console.log("[SIBLINGS] Calculating sibling "+d,e,f),this._sumSiblings(e,f,function(a){return console.log("[SIBLINGS] Calculated "+a),e=a});return c(e)},a.prototype._sumSiblings=function(a,b,c){var d,e,f,g;g=o,e=j.findDeferral(arguments),parseInt(a,16)>parseInt(b,16)?(console.log("[SIBLINGS] Leave1 is bigger than Leave2"),function(c){return function(g){f=new j.Deferrals(g,{parent:e,filename:"./index.iced",funcname:"Stampery._sumSiblings"}),c._sha3Hash(""+a+b,f.defer({assign_fn:function(){return function(){return d=arguments[0]}}(),lineno:96})),f._fulfill()}}(this)(function(a){return function(){return g(c(d))}}(this))):(console.log("[SIBLINGS] Leave2 is bigger than Leave1"),function(c){return function(g){f=new j.Deferrals(g,{parent:e,filename:"./index.iced",funcname:"Stampery._sumSiblings"}),c._sha3Hash(""+b+a,f.defer({assign_fn:function(){return function(){return d=arguments[0]}}(),lineno:100})),f._fulfill()}}(this)(function(a){return function(){return g(c(d))}}(this)))},a.prototype._handleQueueConsumingForHash=function(a){var b,c,d,e;return e=o,c=j.findDeferral(arguments),this.rabbit?void!function(a){return function(e){d=new j.Deferrals(e,{parent:c,filename:"./index.iced",funcname:"Stampery._handleQueueConsumingForHash"}),a.rabbit.createChannel(d.defer({assign_fn:function(a){return function(){return b=arguments[0],a.channel=arguments[1]}}(a),lineno:105})),d._fulfill()}}(this)(function(c){return function(){return console.log("[QUEUE] Bound to "+a+"-clnt",b),e(c.channel.consume(""+a+"-clnt",function(b){var d;return console.log("[QUEUE] Received data!"),d=k.unpack(b.content),1===d[3][0]||-1===d[3][0]?(console.log("[QUEUE] Received BTC proof for "+a),d[1]=(c.ethSiblings[a]||[]).concat(d[1]||[])):2!==d[3][0]&&-2!==d[3][0]||(console.log("[QUEUE] Received ETH proof for "+a),c.ethSiblings[a]=c.convertSiblingArray(d[1])),c.channel.ack(b),c.emit("proof",a,d)}))}}(this)):e(this.emit("error","Error binding to "+a+"-clnt"))},a.prototype.stamp=function(a){var b,c,d,e,f;f=o,d=j.findDeferral(arguments),function(a){return function(b){return a.authed?b():void!function(b){e=new j.Deferrals(b,{parent:d,filename:"./index.iced",funcname:"Stampery.stamp"}),a._auth(e.defer({lineno:129})),e._fulfill()}(b)}}(this)(function(f){return function(){return a=a.toUpperCase(),f.rabbit?void function(g){e=new j.Deferrals(g,{parent:d,filename:"./index.iced",funcname:"Stampery.stamp"}),f.rpc.invoke("stamp",[a],e.defer({assign_fn:function(){return function(){return b=arguments[0],c=arguments[1]}}(),lineno:132})),e._fulfill()}(function(){return f.authed?(console.log("[API] Received response: ",c),b&&(console.log("[RPC] Error: "+b),f.emit("error",b)),f._handleQueueConsumingForHash(a)):f.emit("error","Not authenticated")}):setTimeout(f.stamp.bind(f,a),500)}}(this))},a.prototype.receiveMissedProofs=function(a){return this._handleQueueConsumingForHash(a.toUpperCase())},a}(),m.inherits(e,a),module.exports=e}).call(this);